# Manifest Repair & Maintenance

## Problem Solved

PDFs generated by workflow steps sometimes weren't registered in `manifest.json`, causing them to be excluded from the ASSURED binder. This happened when:
- Forms submitted before manifest registration logic was added
- PDF files manually copied into reports directories
- System crashes during registration
- Development/testing scenarios

## Automatic Solutions

### 1. Prevention (Built-in)
All workflow pages now check if a PDF is already registered before adding duplicate entries:
- `1_Design_Log.py`
- `2_Delivery_Log.py`
- `4_Assessment_Log.py`
- `5_IOTA_Cloning.py`

This prevents future duplicate registrations.

### 2. Manual Repair (Dashboard Button)
**Project Dashboard** â†’ "ðŸ”§ Scan & repair manifest" button
- Scans `reports/` directory for unregistered PDFs
- Auto-detects step from path (`design`, `delivery`, `assessment`, etc.)
- Registers with proper metadata (timestamp, digest, type)
- Shows summary of what was added

### 3. Batch Repair (Command Line)

```bash
# Repair all projects
python scripts/repair_manifests.py

# Repair specific project
python scripts/repair_manifests.py --project "PROJECT_ID"

# Preview what would be repaired (no changes)
python scripts/repair_manifests.py --dry-run
```

## How It Works

1. **Scan**: Recursively searches `data/projects/{project}/reports/` for `*.pdf` files
2. **Compare**: Checks each PDF against registered entries in `manifest.json`
3. **Detect**: Determines step name from directory path:
   - `reports/design/*.pdf` â†’ step: `design`
   - `reports/delivery/*.pdf` â†’ step: `delivery`
   - `reports/assessment/*.pdf` â†’ step: `assessment`
   - `reports/cloning/*.pdf` â†’ step: `cloning`
   - `reports/master_bank_registry/*.pdf` â†’ step: `master_bank_registry`
4. **Extract**: Gets timestamp from filename pattern (e.g., `project-step-1763657963.pdf`)
5. **Register**: Adds missing entries with full metadata (path, timestamp, digest, type)

## Step Detection Patterns

```python
STEP_PATTERNS = {
    "charter": r"charter",
    "design": r"design",
    "delivery": r"delivery",
    "assessment": r"assessment",
    "cloning": r"cloning",
    "seed_bank": r"seed[-_]?bank",
    "master_bank_registry": r"master[-_]?bank",
    "screening": r"screening",
    "form_z": r"form[-_]?z",
}
```

## Example Output

```json
{
  "total_projects": 2,
  "repaired": 1,
  "clean": 1,
  "total_added": 2
}
```

## Integration with Binder

After repair, the binder generation (`0_Project_Dashboard.py` or `scripts/regenerate_binder.py`) will:
1. Load updated manifest with newly registered PDFs
2. De-duplicate (keep latest per step)
3. Order by ASSURED workflow sequence
4. Merge into single comprehensive PDF

## Best Practices

1. **Run repair after bulk imports**: If you copy PDFs manually, run repair
2. **Before generating binder**: Click "Scan & repair" on dashboard
3. **After system recovery**: Run batch repair if database was restored
4. **Regular maintenance**: Include in CI/CD or scheduled tasks

## Preventing Future Issues

All new workflow page submissions now include:
```python
# Check if already registered
already_registered = any(
    isinstance(e, dict) and 
    e.get("path") == pdf_path_str and 
    e.get("step") == step_name
    for e in existing_reports
)
if not already_registered:
    register_file(...)  # Only register if new
```

This prevents duplicate entries while ensuring every PDF is captured.
